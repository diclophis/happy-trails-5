<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>happytrails5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <style>
      #level {
        width: 300px;
        height: 300px;
        background: black;
      }
      #level div {
        width: 100px;
        height: 100px;
        float: left;
        position: relative;
        background-image: url(ns-ew.png);
        background-position: top left;
        background-size: 100% 100%;
        -webkit-transform: translate3d(0px, 0px, 0px);
        transform: translate3d(0px, 0px, 0px);
      }
      #level div#blank {
        background: black;
        opacity: 0;
      }
      #level div.left {
        -webkit-transform: translate3d(-100px, 0, 0);
        transform: translate3d(-100px, 0, 0);
      }
      #level div.right {
        -webkit-transform: translate3d(100px, 0, 0);
        transform: translate3d(100px, 0, 0);
      }
      #level div.up {
        -webkit-transform: translate3d(0, -100px, 0);
        transform: translate3d(0, -100px, 0);
      }
      #level div.down {
        -webkit-transform: translate3d(0, 100px, 0);
        transform: translate3d(0, 100px, 0);
      }
      #level div.animating {
        -webkit-transform: translate3d(0px, 0px, 0px);
        transform: translate3d(0px, 0px, 0px);
        transition: all 0.1s linear;
        -webkit-transition: all 0.1s linear;
      }
    </style>
  </head>
  <body>
    <div id="level">
      <div id="blank"></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    </div>
    <script>
      var level = document.getElementById("level");
      var blank = document.getElementById("blank");
      var width = 3;
      var height = 3;
      var odd = null;
      var animating = false;
      //var frameTimeout = 33;
      var saveClick = null;
      var lastTouched = null;
      var swap = function(index, upOrDown, verticalOrHorizontal) {
        odd = level.children.item(index);
        var insertBeforeNode = (odd.nextSibling == blank) ? odd : odd.nextSibling;
        if (animating == false) {
          level.replaceChild(odd, blank);
          insertBeforeNode ? odd.parentNode.insertBefore(blank, insertBeforeNode) : odd.parentNode.appendChild(blank);
          blank.className = upOrDown ? (verticalOrHorizontal ? "down" : "left") : (verticalOrHorizontal ? "up" : "right");
          odd.className = upOrDown ? (verticalOrHorizontal ? "up" : "right") : (verticalOrHorizontal ? "down" : "left");
          animating = true;

          //setTimeout(function() {
          blank.offsetHeight;
          odd.offsetHeight;

          blank.className = blank.className + " animating";
          odd.className = odd.className + " animating";
          //}, frameTimeout);
        } 
      };
      var completeTransition = function(e) {
        //setTimeout(function() {
          animating = false;
        //}, frameTimeout);
      };
      var indexOf = function(t) {
        var k = 0;
        while (t = t.previousSibling) { ++k;}
        return k;
      };
      var upDownMaker = function(upOrDown, verticalOrHorizontal) {
        var k = indexOf(blank);
        var x = k % width;
        var y = (k - x) / width;
        var dx = verticalOrHorizontal ? 0 : (upOrDown ? 1 : -1);
        var dy = verticalOrHorizontal ? (upOrDown ? -1 : 1) : 0;
        x += dx;
        y += dy;
        if ((dx != 0 && (x) < 3 && x > -1) || (dy != 0 && (y) < 3 && y > -1)) {
          var index = (x) + ((y) * width);
          swap(index, upOrDown, verticalOrHorizontal);
        }
      };
      var processClick = function(target) {
        var k = indexOf(target);
        var x = k % width;
        var y = (k - x) / width;
        var kb = indexOf(blank);
        var xb = kb % width;
        var yb = (kb - xb) / width;
        var dx = (x - xb);
        var dy = (y - yb);
        var one = ((dx) + (dy));
        if ((Math.abs(dx) < 2 && Math.abs(dy) < 2) && (1 == one || -1 == one)) {
          xb += dx;
          yb += dy;
          var index = (xb) + ((yb) * width);
          swap(index, (dx != 0) ? one == 1 : one == -1, dx == 0);
        }
      };
      var onDivClick = function(e) {
        e.preventDefault();
        if (animating) {
        } else {
          processClick(e.target);
        }
        return false;
      };
      var onDivMove = function(e) {
        e.preventDefault();
        var touched = document.elementFromPoint(e.touches[0].pageX, e.touches[0].pageY);
        if (animating) {
        } else {
          //console.log(touched == blank, lastTouched == odd);
          // || (touched == odd && lastTouched == blank)) {
          // if target changed and not changed to blank, reset the whole thing?
          if ((touched == blank && lastTouched == odd)) {
            processClick(odd);
          } else if (touched != odd) {
            processClick(touched);
          }
        }
        lastTouched = touched;
        return false;
      };
      var onKeyUp = function(e) {
        switch(e.keyCode) {
          case 38:
            upDownMaker(false, true);
            break;
          case 39:
            upDownMaker(false, false);
            break;
          case 40:
            upDownMaker(true, true);
            break;
          case 37:
            upDownMaker(true, false);
            break;
        }
      };
      blank.addEventListener("webkitTransitionEnd", completeTransition);
      blank.addEventListener("transitionend", completeTransition);
      level.addEventListener('touchmove', onDivMove);
      level.addEventListener('click', onDivClick);
      window.addEventListener('keyup', onKeyUp);
    </script>
  </body>
</html>
